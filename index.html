<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Ω–µ–æ–Ω–æ–≤–∞—è –º–∞–∑–Ω—è ¬∑ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background: #0b0b0f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî —Ä–æ–∑–æ–≤–æ–µ –Ω–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
        .canvas-wrapper {
            background: #0e0e12;
            border-radius: 2.5rem;
            padding: 1.2rem;
            box-shadow: 
                0 0 8px #ff3eb5,
                0 0 20px #ff3eb5,
                0 0 40px #ff3eb5,
                inset 0 0 6px #ff80c6;
            border: 1px solid #ffa0da;
        }

        /* –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å ‚Äî —Ä–æ–∑–æ–≤—ã–π –Ω–µ–æ–Ω */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.2rem;
            padding: 0.4rem 1.2rem;
            background: #12121a;
            border-radius: 4rem;
            border: 1px solid #ff50b0;
            box-shadow: 0 0 12px #ff3eb5;
            color: #ffc0eb;
            font-weight: 400;
            letter-spacing: 0.5px;
            flex-wrap: wrap;
        }

        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toolbar label {
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #ffb0df;
            text-shadow: 0 0 5px #ff6ec7;
        }

        /* –Ω–µ–æ–Ω–æ–≤—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã */
        input[type="color"] {
            width: 45px;
            height: 38px;
            border: 2px solid #ff7ac9;
            border-radius: 50%;
            background: black;
            cursor: pointer;
            box-shadow: 0 0 12px #ff3eb5;
            padding: 2px;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        /* –¥–∏–∞–ø–∞–∑–æ–Ω —Ç–æ–ª—â–∏–Ω—ã */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        input[type="range"] {
            width: 120px;
            height: 6px;
            background: #2a1a2a;
            border-radius: 10px;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
            box-shadow: 0 0 8px #ff4db2;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #ff24a7;
            border-radius: 50%;
            border: 2px solid black;
            box-shadow: 0 0 14px #ff80c6;
            cursor: pointer;
            transition: 0.1s;
        }
        #lineWidthValue {
            min-width: 2.5rem;
            color: #ffb8e5;
            text-shadow: 0 0 6px magenta;
            font-weight: bold;
        }

        /* –∫–Ω–æ–ø–∫–∏ –≤ –Ω–µ–æ–Ω–µ */
        .neon-btn {
            background: transparent;
            border: 1.5px solid #ff7ac9;
            color: #ffb8e5;
            padding: 0.5rem 1.4rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 0 10px #ff3eb5;
            transition: all 0.2s;
            backdrop-filter: blur(2px);
        }
        .neon-btn:hover {
            background: #ff3eb5;
            color: black;
            border-color: #ffc0eb;
            box-shadow: 0 0 24px #ff66c7;
        }

        /* —Ö–æ–ª—Å—Ç ‚Äî —á—ë—Ä–Ω—ã–π –≥–ª—è–Ω–µ—Ü + –Ω–µ–æ–Ω–æ–≤–∞—è —Ä–∞–º–∫–∞ */
        #boardCanvas {
            display: block;
            width: 800px;
            height: 500px;
            background: #000000;  /* –∞–±—Å–æ–ª—é—Ç–Ω–æ —á—ë—Ä–Ω—ã–π */
            border-radius: 2rem;
            border: 3px solid #ff50b0;
            box-shadow: 
                0 0 20px #ff3eb5,
                inset 0 0 20px #ff3eb5;
            cursor: crosshair;
            touch-action: none; /* –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        }

        /* —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –∫—Ç–æ –æ–Ω–ª–∞–π–Ω */
        .online-indicator {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-left: auto;
            background: #1d1220;
            padding: 0.3rem 1.5rem 0.3rem 1.2rem;
            border-radius: 3rem;
            border: 1px solid #ff6eb5;
            box-shadow: 0 0 16px #ff3eb5;
        }
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: #ff1a9f;
            border-radius: 50%;
            box-shadow: 0 0 12px #ff80d0;
            animation: pulse 1.8s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); background: #ff80d0; }
            100% { opacity: 0.6; transform: scale(1); }
        }

        /* –º–∞–ª–µ–Ω—å–∫–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .status-tip {
            font-size: 0.8rem;
            color: #ffa8df;
            text-shadow: 0 0 4px #f0f;
            margin-left: 1rem;
        }
    </style>
</head>
<body>
<div class="canvas-wrapper">
    <!-- –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Ä–æ–∑–æ–≤—ã–π –Ω–µ–æ–Ω) -->
    <div class="toolbar">
        <div class="toolbar-item">
            <label>üé® —Ü–≤–µ—Ç</label>
            <input type="color" id="colorPicker" value="#ff44b5">
        </div>
        <div class="toolbar-item slider-container">
            <label>üîò –∫–∏—Å—Ç—å</label>
            <input type="range" id="lineWidth" min="2" max="40" value="8" step="1">
            <span id="lineWidthValue">8px</span>
        </div>
        <button class="neon-btn" id="clearBtn">‚ú® –æ—á–∏—Å—Ç–∏—Ç—å</button>
        <div class="online-indicator">
            <span class="pulse-dot"></span>
            <span id="onlineCount" style="color:#ffbfe6; text-shadow:0 0 8px #ff70c7;">2 –æ–Ω–ª–∞–π–Ω</span>
        </div>
        <span class="status-tip">üëÜ —Ä–∏—Å—É–π ‚Äî –≤–∏–¥–Ω–æ –≤—Å–µ–º</span>
    </div>
    <!-- –æ—Å–Ω–æ–≤–Ω–æ–π —á—ë—Ä–Ω—ã–π —Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
    <canvas id="boardCanvas" width="800" height="500"></canvas>
</div>

<script>
    (function() {
        // --- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const canvas = document.getElementById('boardCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        // —Ü–≤–µ—Ç–∞ –∏ –∫–∏—Å—Ç—å
        const colorPicker = document.getElementById('colorPicker');
        const lineWidthInput = document.getElementById('lineWidth');
        const lineWidthSpan = document.getElementById('lineWidthValue');

        // –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        const clearBtn = document.getElementById('clearBtn');

        // —ç–ª–µ–º–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω–∞
        const onlineSpan = document.getElementById('onlineCount');

        // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è ---
        let drawing = false;
        let lastX = 0, lastY = 0;
        let currentColor = colorPicker.value;        // '#ff44b5'
        let currentWidth = parseInt(lineWidthInput.value, 10);

        // --- —ç–º—É–ª—è—Ü–∏—è "–¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" + —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ ---
        // –í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –≤—Å–µ –ø–æ–¥–∫–ª—é—á–∏–≤—à–∏–µ—Å—è –≤–∫–ª–∞–¥–∫–∏/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ä–∏—Å—É–Ω–∫–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞
        // —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª BroadcastChannel (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –µ—Å–ª–∏ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö)
        // –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª—Å—è –±—ã WebSocket, –Ω–æ —É—Å–ª–æ–≤–∏–µ ‚Äî "—Å–∞–π—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ª—é–¥–∏ –º–æ–≥—É—Ç —Ä–∏—Å–æ–≤–∞—Ç—å –∏ —ç—Ç–æ –≤–∏–¥–Ω–æ –≤—Å–µ–º"
        // BroadcastChannel –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º / –æ–¥–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (–≤–∫–ª–∞–¥–∫–∏).
        // –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ WebSocket, –Ω–æ –æ—Å—Ç–∞–≤–∏–º —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É —Ä–∞–±–æ—Ç–∞–ª–æ.

        let channel; // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∑–∂–µ, –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏ (–¥–ª—è "–æ–Ω–ª–∞–π–Ω" —Å—á—ë—Ç—á–∏–∫–∞)
        const sessionId = Math.random().toString(36).substring(2, 8) + Date.now().toString(36);
        let onlineUsers = new Set(); // –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å sessionId –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
        onlineUsers.add(sessionId);  // —Å–∞–º—É —Å–µ–±—è —Ç–æ–∂–µ –¥–æ–±–∞–≤–∏–º

        // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–Ω–ª–∞–π–Ω
        function updateOnlineCount() {
            const count = onlineUsers.size;
            onlineSpan.textContent = count + ' –æ–Ω–ª–∞–π–Ω';
        }

        // --- —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª (–Ω–µ–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è) ---
        try {
            channel = new BroadcastChannel('neon_draw_channel');

            // —Å–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            channel.onmessage = (e) => {
                const data = e.data;

                if (data.type === 'draw') {
                    // —Ä–∏—Å—É–µ–º —à—Ç—Ä–∏—Ö –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    drawLine(
                        data.x0, data.y0,
                        data.x1, data.y1,
                        data.color,
                        data.width
                    );
                } else if (data.type === 'clear') {
                    // –æ—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
                    clearCanvas(true); // true = –Ω–µ —Ä–∞—Å—Å—ã–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
                } else if (data.type === 'join') {
                    // –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–ª–∏ –ø–∏–Ω–≥)
                    const remoteSession = data.sessionId;
                    if (remoteSession !== sessionId) {
                        onlineUsers.add(remoteSession);
                        updateOnlineCount();

                        // —Ç–∞–∫–∂–µ –æ—Ç–≤–µ—á–∞–µ–º –ø—Ä–∏–≤–µ—Ç–æ–º, —á—Ç–æ–±—ã –Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–∑–Ω–∞–ª –æ –Ω–∞—Å
                        channel.postMessage({
                            type: 'join_ack',
                            sessionId: sessionId
                        });
                    }
                } else if (data.type === 'join_ack') {
                    const remoteSession = data.sessionId;
                    if (remoteSession !== sessionId) {
                        onlineUsers.add(remoteSession);
                        updateOnlineCount();
                    }
                } else if (data.type === 'leave') {
                    // –∫—Ç–æ-—Ç–æ –∑–∞–∫—Ä—ã–ª –≤–∫–ª–∞–¥–∫—É
                    const remoteSession = data.sessionId;
                    if (onlineUsers.has(remoteSession)) {
                        onlineUsers.delete(remoteSession);
                        updateOnlineCount();
                    }
                }
            };

            // –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –æ–ø–æ–≤–µ—Å—Ç–∏—Ç—å –≤—Å–µ—Ö –æ —Å–µ–±–µ
            channel.postMessage({
                type: 'join',
                sessionId: sessionId
            });

            // —Ç–∞–∫–∂–µ —Ä–∞–∑ –≤ 5 —Å–µ–∫ –ø–æ—Å—ã–ª–∞–µ–º –ø–∏–Ω–≥, —á—Ç–æ–±—ã –¥–µ—Ä–∂–∞–ª–∏ –≤ —Å–µ—Ç–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –Ω–∞–¥—ë–∂–Ω–æ)
            const pingInterval = setInterval(() => {
                channel.postMessage({
                    type: 'join',
                    sessionId: sessionId
                });
            }, 4000);

            // –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≥–æ–≤–æ—Ä–∏–º, —á—Ç–æ —É—Ö–æ–¥–∏–º
            window.addEventListener('beforeunload', () => {
                channel.postMessage({
                    type: 'leave',
                    sessionId: sessionId
                });
                // –Ω–µ–±–æ–ª—å—à–æ–π –∫–æ—Å—Ç—ã–ª—å: –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å, –Ω–æ –≤ —Ü–µ–ª–æ–º –Ω–æ—Ä–º
            });

            // —Ñ–∏–∫—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö / –∑–∞–∫—Ä—ã—Ç–∏–π
            window.addEventListener('pagehide', () => {
                channel.postMessage({
                    type: 'leave',
                    sessionId: sessionId
                });
            });

        } catch (e) {
            console.warn('broadcastchannel –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ', e);
            // –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏, –Ω–æ —Å–∞–º —Ö–æ–ª—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
        }

        // --- —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏ (—á–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è) ---
        function drawLine(x0, y0, x1, y1, color, width) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.stroke();
        }

        // --- –æ—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞ (—Å –æ–ø—Ü–∏–µ–π –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ö–æ) ---
        function clearCanvas(skipBroadcast = false) {
            // –æ—á–∏—â–∞–µ–º –≤—Å—ë –Ω–∞ —á—ë—Ä–Ω—ã–π
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // –∑–∞–ª–∏–≤–∫–∞ —á—ë—Ä–Ω—ã–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π (—Ö–æ—Ç—è clearRect –∏ —Ç–∞–∫ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º, –Ω–æ —Ñ–æ–Ω —á/–∑ css —á–µ—Ä–Ω—ã–π, –∞ –Ω–∞–º –Ω—É–∂–µ–Ω –∏–º–µ–Ω–Ω–æ —á—ë—Ä–Ω—ã–π —Ö–æ–ª—Å—Ç)
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –Ω–µ–æ–Ω–æ–≤—É—é —Ç–æ—á–∫—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ

            if (!skipBroadcast && channel) {
                channel.postMessage({ type: 'clear' });
            }
        }

        // --- –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ —á—ë—Ä–Ω—ã–º ---
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // --- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–ª—â–∏–Ω—ã ---
        lineWidthInput.addEventListener('input', (e) => {
            currentWidth = parseInt(e.target.value, 10);
            lineWidthSpan.textContent = currentWidth + 'px';
        });

        // --- —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ ---
        colorPicker.addEventListener('input', (e) => {
            currentColor = e.target.value;
        });

        // --- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏ / –∫–∞—Å–∞–Ω–∏–π ---
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;   // —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∫ css
            const scaleY = canvas.height / rect.height;

            let clientX, clientY;

            if (e.touches) {
                // —Å–µ–Ω—Å–æ—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;

            // –æ–≥—Ä–∞–Ω–∏—á–∏–º –∫—Ä–∞—è–º–∏ —Ö–æ–ª—Å—Ç–∞
            return {
                x: Math.min(canvas.width - 1, Math.max(0, x)),
                y: Math.min(canvas.height - 1, Math.max(0, y))
            };
        }

        function startDrawing(e) {
            e.preventDefault();
            drawing = true;
            const coords = getCanvasCoords(e);
            lastX = coords.x;
            lastY = coords.y;
        }

        function draw(e) {
            e.preventDefault();
            if (!drawing) return;

            const coords = getCanvasCoords(e);
            const currentX = coords.x;
            const currentY = coords.y;

            // —Ä–∏—Å—É–µ–º –Ω–∞ —Å–≤–æ—ë–º —Ö–æ–ª—Å—Ç–µ
            drawLine(lastX, lastY, currentX, currentY, currentColor, currentWidth);

            // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏–º (broadcast)
            if (channel) {
                channel.postMessage({
                    type: 'draw',
                    x0: lastX,
                    y0: lastY,
                    x1: currentX,
                    y1: currentY,
                    color: currentColor,
                    width: currentWidth
                });
            }

            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawing(e) {
            drawing = false;
        }

        // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –º—ã—à–∏
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        // —Ç–∞—á-—Å–æ–±—ã—Ç–∏—è (–º–æ–±–∏–ª—å–Ω—ã–µ)
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);

        // –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        clearBtn.addEventListener('click', () => {
            clearCanvas(false); // false ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–º
        });

        // –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∑–∞–ø–æ–ª–Ω–∏–º –æ–Ω–ª–∞–π–Ω-—Å–µ—Ç (—Å–∞–º–∏ —Å–µ–±—è)
        updateOnlineCount();

        // –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏: –µ—Å–ª–∏ –Ω–µ—Ç broadcast, –º–æ–∂–Ω–æ —Ö–æ—Ç—è –±—ã —Ñ–µ–π–∫–æ–≤—ã–π –æ–Ω–ª–∞–π–Ω (–Ω–æ —É –Ω–∞—Å –µ—Å—Ç—å BroadcastChannel)
        // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–º–∏—Ç–∞—Ü–∏—è: –ø–æ —Ç–∞–π–º–µ—Ä—É –ø—É–ª—å—Å
        setInterval(() => {
            if (onlineUsers.size < 2 && channel) {
                // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø—É—Å—Ç—å –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å (–µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 1)
            }
        }, 2000);

        // —Ç–∞–∫ –∫–∞–∫ broadcastchannel –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º–∏, –Ω–æ –ø–æ —É—Å–ª–æ–≤–∏—é —ç—Ç–æ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
        // –¥–ª—è —Ç–µ—Å—Ç–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–æ–∫ —Å —ç—Ç–∏–º —Å–∞–π—Ç–æ–º ‚Äî –ª–∏–Ω–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è.
        // –¥–∏–∑–∞–π–Ω —Ä–æ–∑–æ–≤—ã–π –Ω–µ–æ–Ω –Ω–∞ —á–µ—Ä–Ω–æ–º —Ö–æ–ª—Å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω.
    })();
</script>
</body>
</html>
