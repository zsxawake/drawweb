<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–Ω–ª–∞–π–Ω —Ä–∏—Å–æ–≤–∞–ª–∫–∞ —Å Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1200px;
        }

        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .color-picker {
            width: 50px;
            height: 50px;
            border: 3px solid #fff;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tool-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tool-btn.active {
            background: #667eea;
            color: white;
        }

        .clear-btn {
            background: #ff4757;
            color: white;
        }

        .clear-btn:hover {
            background: #ff3838;
        }

        .slider {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 5px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .canvas-wrapper {
            border: 3px solid #fff;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: white;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            cursor: crosshair;
            touch-action: none;
        }

        .status {
            margin-top: 15px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .online-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .counter {
            font-weight: bold;
            color: #667eea;
        }

        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-left: auto;
        }

        .user-badge {
            background: #e0e7ff;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            color: #4f46e5;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <div class="slider">
                <span>üñåÔ∏è</span>
                <input type="range" id="brushSize" min="1" max="50" value="5">
                <span id="sizeValue">5px</span>
            </div>
            
            <input type="color" id="colorPicker" class="color-picker" value="#000000">
            
            <button class="tool-btn" id="drawBtn">‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å</button>
            <button class="tool-btn" id="eraserBtn">üßΩ –õ–∞—Å—Ç–∏–∫</button>
            <button class="tool-btn clear-btn" id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="canvas-wrapper">
            <canvas id="canvas"></canvas>
        </div>

        <div class="status">
            <div class="online-indicator"></div>
            <span>–û–Ω–ª–∞–π–Ω: <span id="onlineCount" class="counter">0</span></span>
            <div class="users-list" id="usersList"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const SUPABASE_URL = 'https://nevgxteatqacmjhpkbhy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ldmd4dGVhdHFhY21qaHBrYmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MTEyODUsImV4cCI6MjA4NzA4NzI4NX0.fJVfW9m1Ob1GqbRUkhJx7i7v685yID8qkjCN_zhNvkg';
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã canvas
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        let drawing = false;
        let currentX = 0;
        let currentY = 0;
        let brushSize = 5;
        let brushColor = '#000000';
        let isErasing = false;
        let currentUser = null;
        let lastDrawTime = 0;
        const DRAW_THROTTLE = 50; // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 50ms

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight * 0.8;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–∏—Å—É–Ω–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
            loadExistingDrawings();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const brushSizeInput = document.getElementById('brushSize');
        const sizeValue = document.getElementById('sizeValue');
        const colorPicker = document.getElementById('colorPicker');
        const drawBtn = document.getElementById('drawBtn');
        const eraserBtn = document.getElementById('eraserBtn');
        const clearBtn = document.getElementById('clearBtn');
        const onlineCountSpan = document.getElementById('onlineCount');
        const usersListDiv = document.getElementById('usersList');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–∏—Å—Ç–∏
        brushSizeInput.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            sizeValue.textContent = brushSize + 'px';
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
        colorPicker.addEventListener('input', (e) => {
            brushColor = e.target.value;
            isErasing = false;
            drawBtn.classList.add('active');
            eraserBtn.classList.remove('active');
        });

        // –ö–Ω–æ–ø–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        drawBtn.addEventListener('click', () => {
            isErasing = false;
            drawBtn.classList.add('active');
            eraserBtn.classList.remove('active');
            colorPicker.disabled = false;
        });

        // –ö–Ω–æ–ø–∫–∞ –ª–∞—Å—Ç–∏–∫–∞
        eraserBtn.addEventListener('click', () => {
            isErasing = true;
            eraserBtn.classList.add('active');
            drawBtn.classList.remove('active');
            colorPicker.disabled = true;
        });

        // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
        clearBtn.addEventListener('click', async () => {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç –¥–ª—è –≤—Å–µ—Ö?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                await supabase.from('drawings').delete().neq('id', 0);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –Ω–∞ —Ö–æ–ª—Å—Ç–µ
        function draw(x1, y1, x2, y2, size, color, erasing) {
            ctx.beginPath();
            ctx.strokeStyle = erasing ? '#ffffff' : color;
            ctx.lineWidth = size;
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            ctx.closePath();
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
        async function sendDrawingData(x1, y1, x2, y2, size, color, erasing) {
            const now = Date.now();
            if (now - lastDrawTime < DRAW_THROTTLE) return;
            
            lastDrawTime = now;
            
            const { error } = await supabase
                .from('drawings')
                .insert([
                    { 
                        x1, y1, x2, y2, 
                        size, 
                        color: erasing ? '#ffffff' : color,
                        user_id: currentUser?.id 
                    }
                ]);

            if (error) console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', drawDrawing);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Å–∞–Ω–∏—è
        canvas.addEventListener('touchstart', handleTouchStart);
        canvas.addEventListener('touchmove', handleTouchMove);
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            drawing = true;
            const pos = getCoordinates(e);
            currentX = pos.x;
            currentY = pos.y;
        }

        function drawDrawing(e) {
            if (!drawing) return;
            
            e.preventDefault();
            
            const pos = getCoordinates(e);
            const newX = pos.x;
            const newY = pos.y;

            // –†–∏—Å—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            draw(currentX, currentY, newX, newY, brushSize, brushColor, isErasing);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏–º
            sendDrawingData(currentX, currentY, newX, newY, brushSize, brushColor, isErasing);

            currentX = newX;
            currentY = newY;
        }

        function stopDrawing() {
            drawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const pos = getCoordinates(e.touches[0]);
            drawing = true;
            currentX = pos.x;
            currentY = pos.y;
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!drawing) return;
            
            const pos = getCoordinates(e.touches[0]);
            const newX = pos.x;
            const newY = pos.y;

            draw(currentX, currentY, newX, newY, brushSize, brushColor, isErasing);
            sendDrawingData(currentX, currentY, newX, newY, brushSize, brushColor, isErasing);

            currentX = newX;
            currentY = newY;
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            
            return { 
                x: Math.max(0, Math.min(canvas.width, x)),
                y: Math.max(0, Math.min(canvas.height, y))
            };
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–∏—Å—É–Ω–∫–æ–≤
        async function loadExistingDrawings() {
            const { data, error } = await supabase
                .from('drawings')
                .select('*')
                .order('created_at', { ascending: true });

            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            data.forEach(d => {
                draw(d.x1, d.y1, d.x2, d.y2, d.size, d.color, d.color === '#ffffff');
            });
        }

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Ä–∏—Å—É–Ω–∫–∏
        function subscribeToDrawings() {
            supabase
                .channel('drawings-channel')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'drawings' 
                    }, 
                    (payload) => {
                        // –ù–µ —Ä–∏—Å—É–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (payload.new.user_id !== currentUser?.id) {
                            draw(
                                payload.new.x1, 
                                payload.new.y1, 
                                payload.new.x2, 
                                payload.new.y2, 
                                payload.new.size, 
                                payload.new.color,
                                payload.new.color === '#ffffff'
                            );
                        }
                    }
                )
                .subscribe();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        async function setupUser() {
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                    return;
                }
                user = data.user;
            }
            
            currentUser = user;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
            await supabase.from('online_users').upsert({ 
                id: user.id,
                last_seen: new Date().toISOString()
            });

            // –°–ª–µ–¥–∏–º –∑–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            supabase
                .channel('online-users-channel')
                .on('presence', { event: 'sync' }, () => {
                    const presence = supabase.channel('online-users-channel').presenceState();
                    const users = Object.values(presence).flat();
                    onlineCountSpan.textContent = users.length;
                    
                    usersListDiv.innerHTML = users
                        .map(u => `<span class="user-badge">üë§ User ${u.user_id.slice(0,4)}</span>`)
                        .join('');
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await supabase.channel('online-users-channel').track({
                            user_id: user.id,
                            online_at: new Date().toISOString()
                        });
                    }
                });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await setupUser();
            await loadExistingDrawings();
            subscribeToDrawings();
        }

        init();

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                supabase.channel('online-users-channel').untrack();
            }
        });
    </script>
</body>
</html>
